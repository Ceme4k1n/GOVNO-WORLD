<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Турнир самых срущих городов</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        text-align: center;
        background-color: #f4f4f4;
        margin: 0;
        padding: 20px;
      }

      h1 {
        color: #333;
      }

      .tournament-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
      }

      .match {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        background: white;
        padding: 10px;
        border-radius: 8px;
        box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1);
        width: 60%;
      }

      .city {
        font-size: 18px;
        font-weight: bold;
      }

      .prob {
        font-size: 16px;
        color: green;
        margin-left: 5px;
      }

      button {
        padding: 10px;
        border: none;
        background: blue;
        color: white;
        cursor: pointer;
        border-radius: 5px;
      }

      input {
        width: 80px;
        padding: 5px;
        border-radius: 5px;
        border: 1px solid #ccc;
        text-align: center;
      }

      button:hover {
        background: darkblue;
      }
    </style>
  </head>
  <body>
    <h1>Турнир самых срущих городов</h1>
    <div class="tournament-container" id="tournament">
      <!-- Турнирная сетка будет генерироваться здесь -->
    </div>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <script>
      const tg_user_id = window.Telegram.WebApp.initDataUnsafe?.user?.id || null

      // Функция для получения данных турниров с сервера
      async function getTournamentData() {
        try {
          const response = await fetch('/turs/get_all_turns')
          if (!response.ok) throw new Error(`Ошибка: ${response.status}`)

          const tournaments = await response.json()
          return tournaments
        } catch (error) {
          console.error('Ошибка загрузки данных:', error)
          return []
        }
      }

      // Функция для загрузки и отображения турниров на странице
      async function loadTournament() {
        const tournaments = await getTournamentData()
        const tournamentContainer = document.getElementById('tournament')
        tournamentContainer.innerHTML = ''

        // Перебор турниров
        tournaments.forEach((tournament) => {
          const { id, player1, player2, total_bets_p1, total_bets_p2, price_p1_spread, price_p2_spread } = tournament

          // Расчет вероятности для каждого игрока
          const totalBets = total_bets_p1 + total_bets_p2
          const probability1 = totalBets ? ((total_bets_p1 / totalBets) * 100).toFixed(1) : 50
          const probability2 = totalBets ? ((total_bets_p2 / totalBets) * 100).toFixed(1) : 50

          const matchDiv = document.createElement('div')
          matchDiv.classList.add('match')

          matchDiv.innerHTML = `
      <div class="city">${player1} <span class="prob">${probability1}%</span> | Цена голоса: $${price_p1_spread.toFixed(2)}</div>
      <button onclick="placeBet(${id}, ${price_p1_spread}, 1)">П1</button>
      <input type="number" id="bet_${id}" placeholder="Ставка ($)">
      <button onclick="placeBet(${id}, ${price_p2_spread}, 0)">П2</button>
      <div class="city">${player2} <span class="prob">${probability2}%</span> | Цена голоса: $${price_p2_spread.toFixed(2)}</div>
    `
          tournamentContainer.appendChild(matchDiv)
        })
      }

      // Функция для обработки ставки
      async function placeBet(tournament_id, price, side) {
        const betAmount = parseFloat(document.getElementById(`bet_${tournament_id}`).value)
        if (isNaN(betAmount) || betAmount <= 0) {
          alert('Введите корректную сумму ставки!')
          return
        }

        const betSide = side === 1 ? 'П1' : 'П2'
        console.log(`Ставка ${betAmount}$ на ${betSide} в турнире ${tournament_id} с ценой голоса ${price}$`)
        alert(`Вы поставили ${betAmount}$ на турнир ID: ${tournament_id} (${betSide})`)

        let bet_bool
        if (side === 1) {
          bet_bool = true
        } else if (side === 0) {
          bet_bool = false
        }
        try {
          const response = await fetch('/turs/user_bet', {
            method: 'POST', // Метод запроса
            headers: {
              'Content-Type': 'application/json', // Устанавливаем тип данных как JSON
            },
            body: JSON.stringify({
              user_id: tg_user_id,
              tournament_id: tournament_id,
              bet_bool: bet_bool,
              amount: betAmount,
            }), // Отправляем данные в теле запроса
          })

          if (!response.ok) {
            throw new Error(`Ошибка: ${response.status}`)
            alert('Ошибка')
          }

          // Обработка успешного ответа
          console.log('Ставка успешно принята!')
        } catch (error) {
          console.error('Ошибка при отправке ставки на сервер:', error)
        }
      }

      loadTournament()
    </script>
  </body>
</html>
