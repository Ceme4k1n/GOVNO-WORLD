<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet" />
  </head>
  <body>
    <script src="/js/menu.js"></script>
    <script src="/js/lets.js"></script>

    <div class="referrals">
      <h2 class="referrals-title"><img src="/img/invite-friends-icon.svg" alt="" />Пригласить Друзей</h2>
      <p class="referrals-subtitle">Скопируйте ссылку и отправьте её кому угодно, чтобы иметь биг блек кок.</p>
      <div class="referrals-list"></div>
      <div class="referrals-buttons">
        <button id="button_copy_referrals_link"><img src="/img/copy-icon.svg" alt="" />Скопировать</button>
        <button id="button_copy_referrals_share"><img src="/img/share-icon.svg" alt="" />Поделиться</button>
      </div>
    </div>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <script>
      document.addEventListener('DOMContentLoaded', async () => {
        const tg_user_id = window.Telegram.WebApp.initDataUnsafe?.user?.id || null
        const referralsContainer = document.querySelector('.referrals-list')
        const referrals_list_empty = document.createElement('div')
        referrals_list_empty.classList.add('referrals-list-empty')
        referrals_list_empty.innerHTML = '<h1>У вас пока нет рефералов</h1>'
        referralsContainer.appendChild(referrals_list_empty)

        let referrals_link = 'https://t.me/govno_ne_tonet_bot/app?startapp=' + tg_user_id
        const button_copy_referrals_link = document.getElementById('button_copy_referrals_link')
        const button_copy_referrals_share = document.getElementById('button_copy_referrals_share')

        async function fetchReferrals() {
          try {
            const response = await fetch('/referral/get_ref', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ tg_user_id }),
            })

            if (!response.ok) throw new Error('Ошибка запроса: ' + response.status)
            const data = await response.json()

            if (data.referrals && data.referrals.length > 0) {
              renderReferrals(data.referrals)
            } else {
              showEmptyMessage()
            }
          } catch (error) {
            console.error('Ошибка:', error)
          }
        }

        function renderReferrals(referrals) {
          referralsContainer.innerHTML = ''

          referrals.forEach((person) => {
            referralsContainer.innerHTML += `
                <div class="referrals-list-point">
                    <div class="referrals-list-point-avatar">
                        <img src="${'./img/default-avatar.jpg'}" alt="Аватар" />
                    </div>
                    <div class="referrals-list-point-details">
                        <p class="referrals-list-point-name">${person.friend_username || 'Без имени'}</p>
                        <p class="referrals-list-point-time">Время приглашения: ${formatDate(person.created_at)}</p>
                    </div>
                </div>`
          })
        }

        function showEmptyMessage() {
          referralsContainer.innerHTML = ''
          referralsContainer.appendChild(referrals_list_empty)
          referrals_list_empty.style.display = 'block'
        }

        function formatDate(dateString) {
          if (!dateString) return 'Нет данных'
          const date = new Date(dateString)
          return date.toLocaleString('ru-RU', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
          })
        }

        button_copy_referrals_link.addEventListener('click', () => {
          navigator.clipboard
            .writeText(referrals_link)
            .then(() => console.log('Ссылка скопирована'))
            .catch((err) => console.error('Ошибка копирования:', err))
        })

        button_copy_referrals_share.addEventListener('click', () => {
          if (navigator.share) {
            navigator
              .share({
                title: 'Приглашение',
                text: 'Присоединяйся к нам!',
                url: referrals_link,
              })
              .catch((err) => console.error('Ошибка при шаринге:', err))
          } else {
            console.log('Web Share API не поддерживается')
          }
        })

        fetchReferrals()
      })
    </script>
  </body>
</html>
