<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>–ö–∞—Ä—Ç–∞ –≤ Telegram Mini App</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
      body,
      html {
        margin: 0;
        padding: 0;
        width: 100vw;
        height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-between;
        font-family: Arial, sans-serif;
      }

      #map {
        width: 100%;
        height: 70vh;
      }

      .top-buttons,
      .bottom-buttons {
        display: flex;
        gap: 10px;
        padding: 10px;
        width: 100%;
        justify-content: center;
      }

      button {
        padding: 12px 16px;
        font-size: 16px;
        border: none;
        border-radius: 8px;
        background: #007bff;
        color: white;
        cursor: pointer;
        touch-action: manipulation; /* –û—Ç–∫–ª—é—á–∞–µ—Ç –∑—É–º –ø—Ä–∏ –¥–≤–æ–π–Ω–æ–º —Ç–∞–ø–µ */
        flex: 1;
        max-width: 120px;
      }

      button:active {
        background: #0056b3;
      }

      #log {
        position: fixed;
        bottom: 70px;
        left: 10px;
        right: 10px;
        background: rgba(255, 255, 255, 0.95);
        padding: 10px;
        border-radius: 5px;
        font-size: 12px;
        z-index: 1000;
        max-height: 100px;
        overflow-y: auto;
        box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column-reverse; /* –ù–æ–≤—ã–π –ª–æ–≥ —Å–≤–µ—Ä—Ö—É */
      }
    </style>
  </head>
  <body>
    <div class="top-buttons">
      <button id="baseBtn">–ë–∞–∑–∞</button>
      <button id="citiesBtn">–ì–æ—Ä–æ–¥–∞</button>
      <button id="countriesBtn">–°—Ç—Ä–∞–Ω—ã</button>
    </div>

    <div id="map"></div>

    <div class="bottom-buttons">
      <button id="findMeBtn">–ù–∞–π—Ç–∏ –º–µ–Ω—è</button>
      <button id="bigWalkBtn">–°–¥–µ–ª–∞—Ç—å –ø–æ–∫–∞–∫</button>
    </div>

    <div id="log"></div>

    <script>
      const tg = window.Telegram.WebApp
      const locationManager = tg.LocationManager
      const initDataUnsafe = tg.initDataUnsafe

      document.addEventListener('DOMContentLoaded', initializeLocation)

      let map = L.map('map').setView([55.76, 37.64], 10) // –ú–æ—Å–∫–≤–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
      }).addTo(map)

      let logHistory = []

      function addLog(message) {
        logHistory.push(message)
        if (logHistory.length > 5) logHistory.shift()

        const logContainer = document.getElementById('log')
        logContainer.innerHTML = logHistory.map((msg) => `<div>${msg}</div>`).join('')
        logContainer.scrollTop = logContainer.scrollHeight // –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
      }

      function updateLogDisplay() {
        const logElement = document.getElementById('log')
        logElement.innerHTML = logHistory.join('<br>')
        logElement.scrollTop = logElement.scrollHeight
      }

      function getTelegramLocation() {
        return new Promise((resolve, reject) => {
          if (!locationManager.isAccessGranted) {
            addLog('‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏. –û—Ç–∫—Ä—ã–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏...')
            locationManager.openSettings()

            let attempts = 0
            let interval = setInterval(() => {
              locationManager.init(() => {
                if (locationManager.isAccessGranted) {
                  clearInterval(interval)
                  addLog('‚úÖ –î–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –ø–æ–ª—É—á–µ–Ω!')
                  resolve(getTelegramLocation()) // –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—ã–∑–æ–≤
                }
              })
              attempts++
              if (attempts > 10) {
                clearInterval(interval)
                reject('–î–æ—Å—Ç—É–ø —Ç–∞–∫ –∏ –Ω–µ –±—ã–ª –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω.')
              }
            }, 1000)
            return
          }

          addLog('üìç –ó–∞–ø—Ä–æ—Å –≥–µ–æ–ø–æ–∑–∏—Ü–∏–∏ —á–µ—Ä–µ–∑ Telegram...')

          let timeout = setTimeout(() => {
            reject('‚è≥ Telegram –∑–∞–≤–∏—Å –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è.')
          }, 10000)

          locationManager.getLocation((location) => {
            clearTimeout(timeout)
            if (location) {
              addLog(`üìå –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${JSON.stringify(location)}`)
              resolve(location)
            } else {
              reject('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Telegram.')
            }
          })
        })
      }

      function updateMapPosition(location) {
        const { latitude, longitude } = location
        map.setView([latitude, longitude], 15)

        const userIcon = L.icon({
          iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
          iconSize: [25, 41],
          iconAnchor: [12, 41],
        })

        L.marker([latitude, longitude], { icon: userIcon }).addTo(map)

        logHistory.unshift(`–í–∞—à–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${latitude.toFixed(4)}, ${longitude.toFixed(4)}`)
        updateLogDisplay()
      }

      async function initializeLocation() {
        try {
          logHistory = []
          addLog('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...')

          // –Ø–≤–Ω–æ –∂–¥–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
          await new Promise((resolve) => {
            locationManager.init(() => {
              addLog('‚úÖ LocationManager –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω')
              resolve()
            })
          })

          addLog('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏...')

          if (!locationManager.isAccessRequested) {
            addLog('üìå –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏...')
            locationManager.getLocation((location) => {
              if (location) {
                updateMapPosition(location)
              } else {
                addLog('‚ùå –î–æ—Å—Ç—É–ø –Ω–µ –±—ã–ª –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.')
              }
            })
            return
          }

          if (!locationManager.isAccessGranted) {
            addLog('üö´ –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –∑–∞–ø—Ä–µ—â–µ–Ω–∞. –û—Ç–∫—Ä—ã–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏...')
            locationManager.openSettings()
            return
          }

          addLog('üìç –ü–æ–ª—É—á–∞–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ...')
          const telegramLocation = await getTelegramLocation()
          updateMapPosition(telegramLocation)
          loadShits()
        } catch (error) {
          addLog('‚ùå –û—à–∏–±–∫–∞: ' + error)
        }
      }

      document.getElementById('findMeBtn').addEventListener('click', async function () {
        try {
          addLog('–ó–∞–ø—É—Å–∫ –ø–æ–∏—Å–∫–∞ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è...')

          locationManager.init(() => {
            addLog('LocationManager –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω')
          })

          addLog('–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏...')

          if (!locationManager.isAccessGranted) {
            addLog('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –∑–∞–ø—Ä–µ—â–µ–Ω–∞. –û—Ç–∫—Ä—ã–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏...')
            locationManager.openSettings()

            for (let i = 0; i < 10; i++) {
              await new Promise((resolve) => setTimeout(resolve, 1000))
              locationManager.init()
              if (locationManager.isAccessGranted) {
                addLog('–î–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω!')
                break
              }
            }

            if (!locationManager.isAccessGranted) {
              addLog('–î–æ—Å—Ç—É–ø —Ç–∞–∫ –∏ –Ω–µ –±—ã–ª –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω.')
              return
            }
          }

          addLog('–î–æ—Å—Ç—É–ø –µ—Å—Ç—å, –ø–æ–ª—É—á–∞–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ...')

          const location = await getTelegramLocation()
          addLog(`–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ–ª—É—á–µ–Ω—ã: ${JSON.stringify(location)}`)

          updateMapPosition(location)
        } catch (error) {
          addLog('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è: ' + error)
        }
      })

      document.getElementById('bigWalkBtn').addEventListener('click', async function () {
        try {
          const lastShitTime = localStorage.getItem('lastShitTime')
          const now = Date.now()

          if (lastShitTime) {
            const timeDiff = (now - parseInt(lastShitTime)) / 60000 // –†–∞–∑–Ω–∏—Ü–∞ –≤ –º–∏–Ω—É—Ç–∞—Ö
            if (timeDiff < 60) {
              alert(`–°–ª–µ–¥—É—é—â–∏–π –ø–æ—Ö–æ–¥ –≤ —Ç—É–∞–ª–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ ${Math.ceil(60 - timeDiff)} –º–∏–Ω—É—Ç`)
              return
            }
          }

          addLog('üöÄ –ù–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ "–î–æ–±–∞–≤–∏—Ç—å –æ—Ç–º–µ—Ç–∫—É"')

          if (!locationManager.isAccessGranted) {
            addLog('üö´ –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –≤ Telegram')
            return
          }

          const location = await getTelegramLocation()
          if (!location) {
            addLog('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è')
            return
          }

          addLog('üìç –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä...')

          const lat = location.latitude + Math.random() / 10000
          const lon = location.longitude - Math.random() / 10000

          // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ localStorage –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –∑–∞–ø—Ä–æ—Å–∞

          fetch('/map/update_shit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ initDataUnsafe, lat, lon }),
          })
            .then((response) => {
              if (response.status === 200) {
                localStorage.setItem('lastShitTime', now)
                addLog('‚úÖ –û—Ç–º–µ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞!')

                const poopIcon = L.divIcon({
                  className: 'poop-icon',
                  html: `<img src="https://cdn-icons-png.flaticon.com/128/8277/8277628.png" style="width: 40px; height: 40px;"/>`,
                })
                L.marker([lat, lon], { icon: poopIcon }).addTo(map)
                map.setView([lat, lon], 20)
              } else if (response.status === 401) {
                addLog('–¢—ã –ø–æ–∫–∞–∫–∞–ª —É–∂–µ 5 —Ä–∞–∑, –±–æ–ª—å—à–µ —Å–µ–≥–æ–¥–Ω—è –Ω–µ–ª—å–∑—è')
                throw new Error('401 Unauthorized')
              } else if (response.status === 429) {
                addLog('üö´ –ü–æ–∫–∞–∫–∞–µ—à—å —á–µ—Ä–µ–∑ –≤—Ä–µ–º—è')
                throw new Error('429 Too Many Requests')
              } else {
                throw new Error(`Server responded with status ${response.status}`)
              }
            })
            .catch((error) => {
              console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:', error)
              addLog('‚ùå –û—à–∏–±–∫–∞: ' + error.message)
            })
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞:', error)
          addLog('‚ùå –û—à–∏–±–∫–∞: ' + error.message)
        }
      })

      async function loadShits() {
        try {
          const response = await fetch('/map/get_shits', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ initDataUnsafe }),
          })

          if (!response.ok) {
            throw new Error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ: ${response.status}`)
          }

          const data = await response.json()

          if (data && data.shits && Array.isArray(data.shits) && data.shits.length > 0) {
            data.shits.forEach((shit) => {
              const lat = parseFloat(shit.lat)
              const lon = parseFloat(shit.lon)

              if (isNaN(lat) || isNaN(lon)) {
                console.error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:', shit)
                return
              }

              const poopIcon = L.divIcon({
                className: 'poop-icon',
                html: `<img src="https://cdn-icons-png.flaticon.com/128/8277/8277628.png" style="width: 40px; height: 40px;"/>`,
              })

              L.marker([lat, lon], { icon: poopIcon }).addTo(map)
            })
          } else {
            console.log('–ù–µ—Ç —à–∏—Ç-–º–∞—Ä–æ–∫ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è')
          }
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞:', error)
          addLog('‚ùå –û—à–∏–±–∫–∞: ' + error.message)
        }
      }
    </script>

    <script>
      document.getElementById('baseBtn').addEventListener('click', () => {
        addLog('üìÇ –û—Ç–∫—Ä—ã–≤–∞–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö...')

        map.remove()

        map = L.map('map').setView([55.76, 37.64], 5) // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –Ω–∞ –ú–æ—Å–∫–≤—É (–∏–ª–∏ –Ω—É–∂–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã)

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors',
        }).addTo(map)

        addLog('üîÑ –ö–∞—Ä—Ç–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω–∞, –≤—Å–µ –º–∞—Ä–∫–µ—Ä—ã —É–¥–∞–ª–µ–Ω—ã!')
      })

      document.getElementById('citiesBtn').addEventListener('click', async () => {
        const lastCitiesRequest = localStorage.getItem('lastCitiesRequest')

        if (lastCitiesRequest) {
          addLog('–û–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç')
          const citiesTime = (Date.now() - parseInt(lastCitiesRequest)) / 60000 // –†–∞–∑–Ω–∏—Ü–∞ –≤ –º–∏–Ω—É—Ç–∞—Ö
          addLog(citiesTime)

          if (citiesTime < 10) {
            alert(`–°–ª–µ–¥—É—é—â–∏–π –ø–æ–¥—Ä—É–∑ —á–µ—Ä–µ–∑ ${Math.ceil(10 - citiesTime)} –º–∏–Ω—É—Ç`)
            return
          }
        } else {
          addLog('–ï–≥–æ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç')
        }

        try {
          const response = await fetch('/map/get_cities')
          const data = await response.json()
          addLog(data)

          if (data.cities && data.cities.length > 0) {
            data.cities.forEach((city) => {
              const lat = parseFloat(city.lat)
              const lon = parseFloat(city.lon)
              const shitCount = city.shit_count

              // –°–æ–∑–¥–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω—É—é –∏–∫–æ–Ω–∫—É (—Ä–∞–∑–º–µ—Ä –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ "—Å—Ä—É–Ω–æ–≤")
              const poopIcon = L.divIcon({
                className: 'poop-icon',
                html: `<img src="https://cdn-icons-png.flaticon.com/128/19000/19000193.png"
                 style="width: ${30 + shitCount * 2}px; height: ${30 + shitCount * 2}px;"/>`,
              })

              // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä –Ω–∞ –∫–∞—Ä—Ç—É
              L.marker([lat, lon], { icon: poopIcon }).addTo(map).bindPopup(`<b>${city.city}</b><br>üí© –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å–µ—Ä–æ–≤: ${shitCount}`)
            })
            localStorage.setItem('lastCitiesRequest', Date.now())
          } else {
            console.log('–ù–µ—Ç –≥–æ—Ä–æ–¥–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è')
          }
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞:', error)
          addLog('‚ùå –û—à–∏–±–∫–∞: ' + error.message)
        }
      })

      document.getElementById('countriesBtn').addEventListener('click', () => {
        addLog('üìÇ –¢–æ–ø –ø–æ   —Å—Ç—Ä–∞–Ω–∞–º....')
      })
    </script>
  </body>
</html>
