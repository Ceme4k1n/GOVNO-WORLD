<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>–ö–∞—Ä—Ç–∞ –≤ Telegram Mini App</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
      body,
      html {
        margin: 0;
        padding: 0;
        width: 100vw;
        height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-between;
        font-family: Arial, sans-serif;
      }

      #map {
        width: 100%;
        height: 70vh;
      }

      .top-buttons,
      .bottom-buttons {
        display: flex;
        gap: 10px;
        padding: 10px;
        width: 100%;
        justify-content: center;
      }

      button {
        padding: 12px 16px;
        font-size: 16px;
        border: none;
        border-radius: 8px;
        background: #007bff;
        color: white;
        cursor: pointer;
        touch-action: manipulation; /* –û—Ç–∫–ª—é—á–∞–µ—Ç –∑—É–º –ø—Ä–∏ –¥–≤–æ–π–Ω–æ–º —Ç–∞–ø–µ */
        flex: 1;
        max-width: 120px;
      }

      button:active {
        background: #0056b3;
      }

      #log {
        position: fixed;
        bottom: 70px;
        left: 10px;
        right: 10px;
        background: rgba(255, 255, 255, 0.95);
        padding: 10px;
        border-radius: 5px;
        font-size: 12px;
        z-index: 1000;
        max-height: 100px;
        overflow-y: auto;
        box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column-reverse; /* –ù–æ–≤—ã–π –ª–æ–≥ —Å–≤–µ—Ä—Ö—É */
      }
    </style>
  </head>
  <body>
    <div class="top-buttons">
      <button id="citiesBtn">–ì–æ—Ä–æ–¥–∞</button>
      <button id="countriesBtn">–°—Ç—Ä–∞–Ω—ã</button>
    </div>

    <div id="map"></div>

    <div class="bottom-buttons">
      <button id="bigWalkBtn">–ü–æ–∫–∞–∫–∞—Ç—å</button>
      <audio id="clickSound" src="./dry-fart.mp3" preload="auto"></audio>
    </div>

    <div id="log"></div>

    <script>
      const tg = window.Telegram.WebApp
      const locationManager = tg.LocationManager
      const initDataUnsafe = tg.initDataUnsafe
      let selectButton = null

      document.addEventListener('DOMContentLoaded', initializeLocation)

      let map = L.map('map').setView([55.76, 37.64], 10) // –ú–æ—Å–∫–≤–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
      }).addTo(map)

      let logHistory = []

      function addLog(message) {
        logHistory.push(message)
        if (logHistory.length > 5) logHistory.shift()

        const logContainer = document.getElementById('log')
        logContainer.innerHTML = logHistory.map((msg) => `<div>${msg}</div>`).join('')
        logContainer.scrollTop = logContainer.scrollHeight // –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
      }

      function updateLogDisplay() {
        const logElement = document.getElementById('log')
        logElement.innerHTML = logHistory.join('<br>')
        logElement.scrollTop = logElement.scrollHeight
      }

      function getTelegramLocation() {
        return new Promise((resolve, reject) => {
          if (!locationManager.isAccessGranted) {
            addLog('‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏. –û—Ç–∫—Ä—ã–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏...')
            locationManager.openSettings()

            let attempts = 0
            let interval = setInterval(() => {
              locationManager.init(() => {
                if (locationManager.isAccessGranted) {
                  clearInterval(interval)
                  addLog('‚úÖ –î–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –ø–æ–ª—É—á–µ–Ω!')
                  resolve(getTelegramLocation()) // –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—ã–∑–æ–≤
                }
              })
              attempts++
              if (attempts > 10) {
                clearInterval(interval)
                reject('–î–æ—Å—Ç—É–ø —Ç–∞–∫ –∏ –Ω–µ –±—ã–ª –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω.')
              }
            }, 1000)
            return
          }

          addLog('üìç –ó–∞–ø—Ä–æ—Å –≥–µ–æ–ø–æ–∑–∏—Ü–∏–∏ —á–µ—Ä–µ–∑ Telegram...')

          let timeout = setTimeout(() => {
            reject('‚è≥ Telegram –∑–∞–≤–∏—Å –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è.')
          }, 10000)

          locationManager.getLocation((location) => {
            clearTimeout(timeout)
            if (location) {
              addLog(`üìå –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${JSON.stringify(location)}`)
              resolve(location)
            } else {
              reject('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Telegram.')
            }
          })
        })
      }

      function updateMapPosition(location) {
        const { latitude, longitude } = location
        map.setView([latitude, longitude], 15)

        const userIcon = L.icon({
          iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
          iconSize: [25, 41],
          iconAnchor: [12, 41],
        })

        L.marker([latitude, longitude], { icon: userIcon }).addTo(map)

        logHistory.unshift(`–í–∞—à–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${latitude.toFixed(4)}, ${longitude.toFixed(4)}`)
        updateLogDisplay()
      }

      async function initializeLocation() {
        try {
          logHistory = []
          addLog('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...')

          // –Ø–≤–Ω–æ –∂–¥–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
          await new Promise((resolve) => {
            locationManager.init(() => {
              addLog('‚úÖ LocationManager –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω')
              resolve()
            })
          })

          addLog('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏...')

          if (!locationManager.isAccessRequested) {
            addLog('üìå –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏...')
            locationManager.getLocation((location) => {
              if (location) {
                updateMapPosition(location)
              } else {
                addLog('‚ùå –î–æ—Å—Ç—É–ø –Ω–µ –±—ã–ª –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.')
              }
            })
            return
          }

          if (!locationManager.isAccessGranted) {
            addLog('üö´ –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –∑–∞–ø—Ä–µ—â–µ–Ω–∞. –û—Ç–∫—Ä—ã–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏...')
            locationManager.openSettings()
            return
          }

          addLog('üìç –ü–æ–ª—É—á–∞–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ...')
          const telegramLocation = await getTelegramLocation()
          updateMapPosition(telegramLocation)
          loadShits()
        } catch (error) {
          addLog('‚ùå –û—à–∏–±–∫–∞: ' + error)
        }
      }
      document.getElementById('bigWalkBtn').addEventListener('click', async function () {
        if (selectButton != 'shit') {
          selectButton = 'shit'
          reloadMap()
          loadShits()
          const sound = document.getElementById('clickSound')
          sound.play().catch((error) => {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–∏ –∑–≤—É–∫–∞:', error)
          })
          try {
            const lastShitTime = localStorage.getItem('lastShitTime')

            const now = Date.now()

            addLog('üöÄ –ù–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ "–î–æ–±–∞–≤–∏—Ç—å –æ—Ç–º–µ—Ç–∫—É"')

            if (!locationManager.isAccessGranted) {
              addLog('üö´ –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –≤ Telegram')
              return
            }

            const location = await getTelegramLocation()
            if (!location) {
              addLog('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è')
              return
            }
            updateMapPosition(location)

            // if (lastShitTime) {
            //   const timeDiff = (now - parseInt(lastShitTime)) / 60000 // –†–∞–∑–Ω–∏—Ü–∞ –≤ –º–∏–Ω—É—Ç–∞—Ö
            //   if (timeDiff < 60) {
            //     alert(`–°–ª–µ–¥—É—é—â–∏–π –ø–æ—Ö–æ–¥ –≤ —Ç—É–∞–ª–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ ${Math.ceil(60 - timeDiff)} –º–∏–Ω—É—Ç`)
            //     return
            //   }
            // }

            addLog('üìç –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä...')

            const lat = location.latitude + Math.random() / 10000
            const lon = location.longitude - Math.random() / 10000

            let nearbyIndexes = []

            for (let i = 0; i < places.length; i++) {
              const place = places[i]
              if (isWithinRadius(lat, lon, place.lat, place.lng, 300)) {
                nearbyIndexes.push(i)
              }
            }

            if (nearbyIndexes.length === 0) {
              addLog('üì≠ –ü–æ–±–ª–∏–∑–æ—Å—Ç–∏ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–µ—Å—Ç.')
              addLog('–†–µ–∑—É–ª—å—Ç–∞—Ç: []')
            } else {
              addLog('–†–µ–∑—É–ª—å—Ç–∞—Ç: [' + nearbyIndexes.join(', ') + ']')
            }

            fetch('/map/update_shit', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ initDataUnsafe, lat, lon, places_index: nearbyIndexes }),
            })
              .then((response) => {
                if (response.status === 200) {
                  localStorage.setItem('lastShitTime', now)
                  addLog('‚úÖ –û—Ç–º–µ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞!')

                  const poopIcon = L.divIcon({
                    className: 'poop-icon',
                    html: `<img src="https://cdn-icons-png.flaticon.com/128/8277/8277628.png" style="width: 40px; height: 40px;"/>`,
                  })
                  L.marker([lat, lon], { icon: poopIcon }).addTo(map)
                  map.setView([lat, lon], 20)

                  try {
                    const cached = JSON.parse(localStorage.getItem('cachedShits') || '[]')
                    cached.push({ lat, lon, skin: 0, date: new Date() })
                    localStorage.setItem('cachedShits', JSON.stringify(cached))
                  } catch (e) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–µ—à–∞:', e)
                  }
                } else if (response.status === 401) {
                  addLog('–¢—ã –ø–æ–∫–∞–∫–∞–ª —É–∂–µ 5 —Ä–∞–∑, –±–æ–ª—å—à–µ —Å–µ–≥–æ–¥–Ω—è –Ω–µ–ª—å–∑—è')
                  throw new Error('401 Unauthorized')
                } else if (response.status === 429) {
                  addLog('üö´ –ü–æ–∫–∞–∫–∞–µ—à—å —á–µ—Ä–µ–∑ –≤—Ä–µ–º—è')
                  throw new Error('429 Too Many Requests')
                } else {
                  throw new Error(`Server responded with status ${response.status}`)
                }
              })
              .catch((error) => {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:', error)
                addLog('‚ùå –û—à–∏–±–∫–∞: ' + error.message)
              })
          } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞:', error)
            addLog('‚ùå –û—à–∏–±–∫–∞: ' + error.message)
          }
        }
      })

      document.getElementById('citiesBtn').addEventListener('click', function () {
        if (selectButton != 'city') {
          selectButton = 'city'
          reloadMap()
          get_cities()
        } else {
        }
      })

      document.getElementById('countriesBtn').addEventListener('click', function () {
        if (selectButton != 'country') {
          selectButton = 'country'
          reloadMap()
          get_countries()
        } else {
        }
      })

      async function get_cities() {
        try {
          const lastCitiTime = localStorage.getItem('lastCitiTime')
          const cachedCities = localStorage.getItem('cachedCities')
          const now = Date.now()

          if (lastCitiTime) {
            const timeDiff = (now - parseInt(lastCitiTime)) / 60000 // –†–∞–∑–Ω–∏—Ü–∞ –≤ –º–∏–Ω—É—Ç–∞—Ö

            if (timeDiff < 5 && cachedCities) {
              addLog(`‚ö° –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ ${Math.ceil(5 - timeDiff)} –º–∏–Ω—É—Ç`)
              renderCities(JSON.parse(cachedCities))
              return
            }
          }

          addLog('üåç –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ...')
          const response = await fetch('/map/get_cities', {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' },
          })

          if (!response.ok) {
            throw new Error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ: ${response.status}`)
          }

          const data = await response.json()

          if (data.cities && Array.isArray(data.cities)) {
            localStorage.setItem('cachedCities', JSON.stringify(data.cities)) // –ö—ç—à–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
            localStorage.setItem('lastCitiTime', now.toString()) // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞
            renderCities(data.cities) // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≥–æ—Ä–æ–¥–∞ –Ω–∞ –∫–∞—Ä—Ç–µ
          } else {
            addLog('üö´ –ù–µ—Ç –≥–æ—Ä–æ–¥–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è')
          }
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞:', error)
          addLog('‚ùå –û—à–∏–±–∫–∞: ' + error.message)
        }
      }

      async function get_countries() {
        try {
          const lastCountryTime = localStorage.getItem('lastCountryTime')
          const cachedCountries = localStorage.getItem('cachedCountries')
          const now = Date.now()

          if (lastCountryTime) {
            const timeDiff = (now - parseInt(lastCountryTime)) / 60000 // –†–∞–∑–Ω–∏—Ü–∞ –≤ –º–∏–Ω—É—Ç–∞—Ö

            if (timeDiff < 5 && cachedCountries) {
              addLog(`‚ö° –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ ${Math.ceil(5 - timeDiff)} –º–∏–Ω—É—Ç`)
              renderCountries(JSON.parse(cachedCountries))
              return
            }
          }

          addLog('üåç –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ...')
          const response = await fetch('/map/get_countries', {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' },
          })

          if (!response.ok) {
            throw new Error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ: ${response.status}`)
          }

          const data = await response.json()

          if (data.countries && Array.isArray(data.countries)) {
            localStorage.setItem('cachedCountries', JSON.stringify(data.countries)) // –ö—ç—à–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
            localStorage.setItem('lastCountryTime', now.toString()) // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞
            renderCountries(data.countries) // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≥–æ—Ä–æ–¥–∞ –Ω–∞ –∫–∞—Ä—Ç–µ
          } else {
            addLog('üö´ –ù–µ—Ç –≥–æ—Ä–æ–¥–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è')
          }
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞:', error)
          addLog('‚ùå –û—à–∏–±–∫–∞: ' + error.message)
        }
      }

      function renderCities(cities) {
        cities.forEach((city) => {
          const lat = parseFloat(city.lat)
          const lon = parseFloat(city.lon)
          const shitCount = city.shit_count

          if (isNaN(lat) || isNaN(lon)) {
            console.error('‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:', city)
            return
          }

          const poopIcon = L.divIcon({
            className: 'poop-icon',
            html: `<img src="https://cdn-icons-png.flaticon.com/128/1719/1719653.png"
             style="width: ${30 + shitCount * 2}px; height: ${30 + shitCount * 2}px;"/>`,
          })

          L.marker([lat, lon], { icon: poopIcon }).addTo(map).bindPopup(`<b>${city.city}</b><br>üí© –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å–µ—Ä–æ–≤: ${shitCount}`)

          addStaticMarkers()
        })
      }

      function renderCountries(countries) {
        countries.forEach((country) => {
          const lat = parseFloat(country.lat)
          const lon = parseFloat(country.lon)
          const shitCount = country.shit_count

          if (isNaN(lat) || isNaN(lon)) {
            console.error('‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:', country)
            return
          }

          const poopIcon = L.divIcon({
            className: 'poop-icon',
            html: `<img src="https://cdn-icons-png.flaticon.com/128/1719/1719653.png"
             style="width: ${30 + shitCount * 2}px; height: ${30 + shitCount * 2}px;"/>`,
          })

          L.marker([lat, lon], { icon: poopIcon }).addTo(map).bindPopup(`<b>${country.country}</b><br>üí© –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å–µ—Ä–æ–≤: ${shitCount}`)

          addStaticMarkers()
        })
      }

      function addStaticMarkers() {
        places.forEach((place) => {
          const lat = parseFloat(place.lat)
          const lng = parseFloat(place.lng)

          if (isNaN(lat) || isNaN(lng)) {
            console.error('‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:', place)
            return
          }

          // –ò—Å–ø–æ–ª—å–∑—É–µ–º divIcon –≤–º–µ—Å—Ç–æ L.icon
          const placeIcon = L.divIcon({
            className: 'custom-icon',
            html: `<img src="${place.iconUrl}" style="width: 40px; height: 40px;"/>`,
          })

          // –°–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä —Å divIcon
          const marker = L.marker([lat, lng], { icon: placeIcon }).addTo(map).bindPopup(`<b>${place.title}</b><br>${place.type}<br>${place.city}`)

          marker.on('click', () => {
            addLog(`üìç ${place.title} ‚Äî ${place.city}`)
          })
        })
      }

      function renderShits(shits) {
        shits.forEach((shit) => {
          const lat = parseFloat(shit.lat)
          const lon = parseFloat(shit.lon)

          if (isNaN(lat) || isNaN(lon)) {
            console.error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:', shit)
            return
          }

          // –í—ã–±–∏—Ä–∞–µ–º –∏–∫–æ–Ω–∫—É –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–Ω–∞—á–µ–Ω–∏—è skin
          let iconUrl
          switch (shit.skin) {
            case 0:
              iconUrl = 'https://cdn-icons-png.flaticon.com/128/8277/8277628.png' // –î–µ—Ñ–æ–ª—Ç–Ω–∞—è –∏–∫–æ–Ω–∫–∞
              break
            case 1:
              iconUrl = 'https://i.imgur.com/eznSQgw.png' // –ò–∫–æ–Ω–∫–∞ –¥–ª—è —Å–∫–∏–Ω–∞ 1
              break
            case 2:
              iconUrl = 'https://cdn-icons-png.flaticon.com/128/1719/1719654.png' // –ò–∫–æ–Ω–∫–∞ –¥–ª—è —Å–∫–∏–Ω–∞ 2
              break
            case 3:
              iconUrl = 'https://cdn-icons-png.flaticon.com/128/1719/1719655.png' // –ò–∫–æ–Ω–∫–∞ –¥–ª—è —Å–∫–∏–Ω–∞ 3
              break
            case 4:
              iconUrl = 'https://cdn-icons-png.flaticon.com/128/1719/1719656.png' // –ò–∫–æ–Ω–∫–∞ –¥–ª—è —Å–∫–∏–Ω–∞ 4
              break
            default:
              iconUrl = 'https://cdn-icons-png.flaticon.com/128/8277/8277628.png' // –ò–∫–æ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
              break
          }

          // –°–æ–∑–¥–∞–µ–º –∏–∫–æ–Ω–∫—É —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º URL
          const poopIcon = L.divIcon({
            className: 'poop-icon',
            html: `<img src="${iconUrl}" style="width: 40px; height: 40px;"/>`,
          })

          L.marker([lat, lon], { icon: poopIcon }).addTo(map)

          addStaticMarkers()
        })
      }

      function reloadMap() {
        map.remove()

        map = L.map('map').setView([55.76, 37.64], 5)

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors',
        }).addTo(map)

        addLog('üîÑ –ö–∞—Ä—Ç–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω–∞, –≤—Å–µ –º–∞—Ä–∫–µ—Ä—ã —É–¥–∞–ª–µ–Ω—ã!')
      }

      async function loadShits() {
        try {
          const lastShitLoadTime = localStorage.getItem('lastShitLoadTime')
          const cachedShits = localStorage.getItem('cachedShits')
          const now = Date.now()

          if (lastShitLoadTime) {
            const timeDiff = (now - parseInt(lastShitLoadTime)) / 60000 // –†–∞–∑–Ω–∏—Ü–∞ –≤ –º–∏–Ω—É—Ç–∞—Ö

            if (timeDiff < 5 && cachedShits) {
              addLog(`‚ö° –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≥–æ–≤–Ω–∞. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ ${Math.ceil(5 - timeDiff)} –º–∏–Ω—É—Ç`)
              renderShits(JSON.parse(cachedShits))
              return
            }
          }

          addLog('üåç –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ...')
          const response = await fetch('/map/get_shits', {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' },
          })

          if (!response.ok) {
            throw new Error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ: ${response.status}`)
          }

          const data = await response.json()

          if (data.shits && Array.isArray(data.shits)) {
            localStorage.setItem('cachedShits', JSON.stringify(data.shits)) // –ö—ç—à–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
            localStorage.setItem('lastShitLoadTime', now.toString()) // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞
            renderShits(data.shits) // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≥–æ—Ä–æ–¥–∞ –Ω–∞ –∫–∞—Ä—Ç–µ
          } else {
            addLog('üö´ –ù–µ—Ç –≥–æ—Ä–æ–¥–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è')
          }
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞:', error)
          addLog('‚ùå –û—à–∏–±–∫–∞: ' + error.message)
        }
      }

      function isWithinRadius(userLat, userLng, targetLat, targetLng, radiusMeters = 300) {
        const userPoint = L.latLng(userLat, userLng)
        const targetPoint = L.latLng(targetLat, targetLng)

        const distance = map.distance(userPoint, targetPoint) // –≤ –º–µ—Ç—Ä–∞—Ö

        return distance <= radiusMeters
      }

      const places = [
        {
          title: 'üè¢ Telegram FZ LLC (–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –æ—Ñ–∏—Å)',
          type: '–û—Ñ–∏—Å',
          city: '–î—É–±–∞–π, –û–ê–≠',
          lat: 25.1002,
          lng: 55.1693,
          iconUrl: 'https://i.imgur.com/eznSQgw.png', // –ú–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Å–≤–æ–π URL
          iconSize: [40, 40],
          iconAnchor: [20, 40], // –¶–µ–Ω—Ç—Ä –∏–∫–æ–Ω–∫–∏ –ø–æ –æ—Å–Ω–æ–≤–∞–Ω–∏—é
          popupAnchor: [0, -35], // –°–º–µ—â–µ–Ω–∏–µ popup –Ω–∞–¥ –∏–∫–æ–Ω–∫–æ–π
        },
        {
          title: 'üß† TON Foundation (—é—Ä–∏–¥–∏—á–µ—Å–∫–∞—è —à—Ç–∞–±-–∫–≤–∞—Ä—Ç–∏—Ä–∞)',
          type: '–û—Ñ–∏—Å',
          city: '–¶—É–≥, –®–≤–µ–π—Ü–∞—Ä–∏—è',
          lat: 47.1741,
          lng: 8.5178,
          iconUrl: 'https://i.imgur.com/1DwAMm9.png', // –ú–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Å–≤–æ–π URL
          iconSize: [40, 40],
          iconAnchor: [20, 40], // –¶–µ–Ω—Ç—Ä –∏–∫–æ–Ω–∫–∏ –ø–æ –æ—Å–Ω–æ–≤–∞–Ω–∏—é
          popupAnchor: [0, -35], // –°–º–µ—â–µ–Ω–∏–µ popup –Ω–∞–¥ –∏–∫–æ–Ω–∫–æ–π
        },
        {
          title: 'üß† –í–∏–ª–ª–∞ –ü–∞—à–∏ –î—É—Ä–æ–≤–∞',
          type: '–í–∏–ª–ª–∞',
          city: '–î—É–±–∞–π, –û–ê–≠',
          lat: 25.11206,
          lng: 55.1378,
          iconUrl: 'https://i.imgur.com/1DwAMm9.png', // –ú–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Å–≤–æ–π URL
          iconSize: [40, 40],
          iconAnchor: [20, 40], // –¶–µ–Ω—Ç—Ä –∏–∫–æ–Ω–∫–∏ –ø–æ –æ—Å–Ω–æ–≤–∞–Ω–∏—é
          popupAnchor: [0, -35], // –°–º–µ—â–µ–Ω–∏–µ popup –Ω–∞–¥ –∏–∫–æ–Ω–∫–æ–π
        },
        {
          title: 'üß† –°–ø–æ—Ä—Ç–∑–∞–ª –ü–∞—à–∏ –î—É—Ä–æ–≤–∞',
          type: '–°–ø–æ—Ä—Ç–∑–∞–ª',
          city: '–î—É–±–∞–π, –û–ê–≠',
          lat: 25.19696,
          lng: 55.27836,
          iconUrl: 'https://i.imgur.com/1DwAMm9.png', // –ú–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Å–≤–æ–π URL
          iconSize: [40, 40],
          iconAnchor: [20, 40], // –¶–µ–Ω—Ç—Ä –∏–∫–æ–Ω–∫–∏ –ø–æ –æ—Å–Ω–æ–≤–∞–Ω–∏—é
          popupAnchor: [0, -35], // –°–º–µ—â–µ–Ω–∏–µ popup –Ω–∞–¥ –∏–∫–æ–Ω–∫–æ–π
        },
        {
          title: 'üß† –î–æ–º –ü–∞—à–∏ –î—É—Ä–æ–≤–∞ –≤–æ –§—Ä–∞–Ω—Ü–∏–∏',
          type: '–î–æ–º',
          city: '–ü–∞—Ä–∏–∂, –§—Ä–∞–Ω—Ü–∏—è',
          lat: 49.43921,
          lng: 0.30993,
          iconUrl: 'https://i.imgur.com/1DwAMm9.png', // –ú–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Å–≤–æ–π URL
          iconSize: [40, 40],
          iconAnchor: [20, 40], // –¶–µ–Ω—Ç—Ä –∏–∫–æ–Ω–∫–∏ –ø–æ –æ—Å–Ω–æ–≤–∞–Ω–∏—é
          popupAnchor: [0, -35], // –°–º–µ—â–µ–Ω–∏–µ popup –Ω–∞–¥ –∏–∫–æ–Ω–∫–æ–π
        },
        {
          title: 'üß† –ë–∞–∑–∞ –°–ø–µ—Ä–º–∏–∫—Å–∞',
          type: '–ë–∞–∑–∞',
          city: '–î—É–±–∞–π, –û–ê–≠',
          lat: 25.10155,
          lng: 55.16452,
          iconUrl: 'https://i.imgur.com/1DwAMm9.png', // –ú–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Å–≤–æ–π URL
          iconSize: [40, 40],
          iconAnchor: [20, 40], // –¶–µ–Ω—Ç—Ä –∏–∫–æ–Ω–∫–∏ –ø–æ –æ—Å–Ω–æ–≤–∞–Ω–∏—é
          popupAnchor: [0, -35], // –°–º–µ—â–µ–Ω–∏–µ popup –Ω–∞–¥ –∏–∫–æ–Ω–∫–æ–π
        },
        {
          title: 'üß† –ë–∞–∑–∞ –°–∞—à–∏ –ù–æ—Ç–∫–æ–∏–Ω–µ—Ä–∞',
          type: '–ë–∞–∑–∞',
          city: '–î—É–±–∞–π, –û–ê–≠',
          lat: 25.22825,
          lng: 55.28448,
          iconUrl: 'https://i.imgur.com/1DwAMm9.png', // –ú–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Å–≤–æ–π URL
          iconSize: [40, 40],
          iconAnchor: [20, 40], // –¶–µ–Ω—Ç—Ä –∏–∫–æ–Ω–∫–∏ –ø–æ –æ—Å–Ω–æ–≤–∞–Ω–∏—é
          popupAnchor: [0, -35], // –°–º–µ—â–µ–Ω–∏–µ popup –Ω–∞–¥ –∏–∫–æ–Ω–∫–æ–π
        },
      ]
    </script>
  </body>
</html>
