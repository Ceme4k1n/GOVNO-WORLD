<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ö–∞—Ä—Ç–∞ –≤ Telegram Mini App</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
      button {
        padding: 10px 20px;
        margin: 5px;
        font-size: 16px;
        z-index: 1000;
        position: relative;
      }
      #log {
        position: fixed;
        top: 10px;
        left: 10px;
        background: rgba(255, 255, 255, 0.9);
        padding: 10px;
        border-radius: 5px;
        max-width: 300px;
        font-family: Arial, sans-serif;
        font-size: 12px;
        z-index: 1000;
      }
      #map {
        width: 100vw;
        height: 90vh;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <button id="findMeBtn">–ù–∞–π—Ç–∏ –º–µ–Ω—è</button>
    <div id="log"></div>

    <script>
      const tg = window.Telegram.WebApp
      const locationManager = tg.LocationManager

      document.addEventListener('DOMContentLoaded', initializeLocation)

      let map = L.map('map').setView([55.76, 37.64], 10) // –ú–æ—Å–∫–≤–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
      }).addTo(map)

      let logHistory = []

      function addLog(message) {
        logHistory.push(message)
        updateLogDisplay()
      }

      function updateLogDisplay() {
        const logElement = document.getElementById('log')
        logElement.innerHTML = logHistory.join('<br>')
        logElement.scrollTop = logElement.scrollHeight
      }

      function getTelegramLocation() {
        return new Promise((resolve, reject) => {
          if (!locationManager.isAccessGranted) {
            addLog('‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏. –û—Ç–∫—Ä—ã–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏...')
            locationManager.openSettings()

            let attempts = 0
            let interval = setInterval(() => {
              locationManager.init(() => {
                if (locationManager.isAccessGranted) {
                  clearInterval(interval)
                  addLog('‚úÖ –î–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –ø–æ–ª—É—á–µ–Ω!')
                  resolve(getTelegramLocation()) // –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—ã–∑–æ–≤
                }
              })
              attempts++
              if (attempts > 10) {
                clearInterval(interval)
                reject('–î–æ—Å—Ç—É–ø —Ç–∞–∫ –∏ –Ω–µ –±—ã–ª –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω.')
              }
            }, 1000)
            return
          }

          addLog('üìç –ó–∞–ø—Ä–æ—Å –≥–µ–æ–ø–æ–∑–∏—Ü–∏–∏ —á–µ—Ä–µ–∑ Telegram...')

          let timeout = setTimeout(() => {
            reject('‚è≥ Telegram –∑–∞–≤–∏—Å –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è.')
          }, 10000)

          locationManager.getLocation((location) => {
            clearTimeout(timeout)
            if (location) {
              addLog(`üìå –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${JSON.stringify(location)}`)
              resolve(location)
            } else {
              reject('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Telegram.')
            }
          })
        })
      }

      function updateMapPosition(location) {
        const { latitude, longitude } = location
        map.setView([latitude, longitude], 15)

        const userIcon = L.icon({
          iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
          iconSize: [25, 41],
          iconAnchor: [12, 41],
        })

        L.marker([latitude, longitude], { icon: userIcon }).addTo(map)

        logHistory.unshift(`–í–∞—à–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${latitude.toFixed(4)}, ${longitude.toFixed(4)}`)
        updateLogDisplay()
      }

      async function initializeLocation() {
        try {
          logHistory = []
          addLog('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...')

          // –Ø–≤–Ω–æ –∂–¥–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
          await new Promise((resolve) => {
            locationManager.init(() => {
              addLog('‚úÖ LocationManager –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω')
              resolve()
            })
          })

          addLog('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏...')

          if (!locationManager.isAccessRequested) {
            addLog('üìå –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏...')
            locationManager.getLocation((location) => {
              if (location) {
                updateMapPosition(location)
              } else {
                addLog('‚ùå –î–æ—Å—Ç—É–ø –Ω–µ –±—ã–ª –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.')
              }
            })
            return
          }

          if (!locationManager.isAccessGranted) {
            addLog('üö´ –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –∑–∞–ø—Ä–µ—â–µ–Ω–∞. –û—Ç–∫—Ä—ã–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏...')
            locationManager.openSettings()
            return
          }

          addLog('üìç –ü–æ–ª—É—á–∞–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ...')
          const telegramLocation = await getTelegramLocation()
          updateMapPosition(telegramLocation)
        } catch (error) {
          addLog('‚ùå –û—à–∏–±–∫–∞: ' + error)
        }
      }

      document.getElementById('findMeBtn').addEventListener('click', async function () {
        try {
          addLog('–ó–∞–ø—É—Å–∫ –ø–æ–∏—Å–∫–∞ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è...')

          locationManager.init(() => {
            addLog('LocationManager –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω')
          })

          addLog('–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏...')

          if (!locationManager.isAccessGranted) {
            addLog('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –∑–∞–ø—Ä–µ—â–µ–Ω–∞. –û—Ç–∫—Ä—ã–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏...')
            locationManager.openSettings()

            for (let i = 0; i < 10; i++) {
              await new Promise((resolve) => setTimeout(resolve, 1000))
              locationManager.init()
              if (locationManager.isAccessGranted) {
                addLog('–î–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω!')
                break
              }
            }

            if (!locationManager.isAccessGranted) {
              addLog('–î–æ—Å—Ç—É–ø —Ç–∞–∫ –∏ –Ω–µ –±—ã–ª –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω.')
              return
            }
          }

          addLog('–î–æ—Å—Ç—É–ø –µ—Å—Ç—å, –ø–æ–ª—É—á–∞–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ...')

          const location = await getTelegramLocation()
          addLog(`–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ–ª—É—á–µ–Ω—ã: ${JSON.stringify(location)}`)

          updateMapPosition(location)
        } catch (error) {
          addLog('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è: ' + error)
        }
      })
    </script>
  </body>
</html>
